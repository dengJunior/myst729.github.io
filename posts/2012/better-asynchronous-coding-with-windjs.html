<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一个平庸的码农 | 借助 Wind.js 编写更流畅的异步代码</title>
    <meta name="description" content="一个平庸的码农">
    <link rel="icon" href="/static/logo.png" type="image/png" sizes="256x256">
  <link rel="icon" href="/static/logo.svg" type="image/svg+xml" sizes="any">
  <link rel="stylesheet" href="/static/fontello.css">
    
    <link rel="preload" href="/assets/css/0.styles.ea168385.css" as="style"><link rel="preload" href="/assets/js/app.d4ce6780.js" as="script"><link rel="preload" href="/assets/js/47.600ab990.js" as="script"><link rel="prefetch" href="/assets/js/28.ab8ea044.js"><link rel="prefetch" href="/assets/js/1.460b6d99.js"><link rel="prefetch" href="/assets/js/2.4585c69e.js"><link rel="prefetch" href="/assets/js/3.560fc6c4.js"><link rel="prefetch" href="/assets/js/4.b8e26cb0.js"><link rel="prefetch" href="/assets/js/5.a4031868.js"><link rel="prefetch" href="/assets/js/6.9508ab9a.js"><link rel="prefetch" href="/assets/js/7.fa73cd7e.js"><link rel="prefetch" href="/assets/js/8.de02dda4.js"><link rel="prefetch" href="/assets/js/9.4f05d119.js"><link rel="prefetch" href="/assets/js/10.ee35eaa0.js"><link rel="prefetch" href="/assets/js/11.2af52383.js"><link rel="prefetch" href="/assets/js/12.9cd5fd43.js"><link rel="prefetch" href="/assets/js/13.dfe3a00b.js"><link rel="prefetch" href="/assets/js/14.3476e7ae.js"><link rel="prefetch" href="/assets/js/15.e4be0105.js"><link rel="prefetch" href="/assets/js/16.5ea9c46d.js"><link rel="prefetch" href="/assets/js/17.b80775b3.js"><link rel="prefetch" href="/assets/js/18.d7b44c49.js"><link rel="prefetch" href="/assets/js/19.018a17cd.js"><link rel="prefetch" href="/assets/js/20.e7784bab.js"><link rel="prefetch" href="/assets/js/21.20740583.js"><link rel="prefetch" href="/assets/js/22.efb6ef79.js"><link rel="prefetch" href="/assets/js/23.b4bd3298.js"><link rel="prefetch" href="/assets/js/24.d5547775.js"><link rel="prefetch" href="/assets/js/25.46c855ac.js"><link rel="prefetch" href="/assets/js/26.d85c22d8.js"><link rel="prefetch" href="/assets/js/27.96361ded.js"><link rel="prefetch" href="/assets/js/29.2085f5ec.js"><link rel="prefetch" href="/assets/js/30.4f6ac586.js"><link rel="prefetch" href="/assets/js/31.57541ec8.js"><link rel="prefetch" href="/assets/js/32.dee6b356.js"><link rel="prefetch" href="/assets/js/33.72192c86.js"><link rel="prefetch" href="/assets/js/34.d1d397ef.js"><link rel="prefetch" href="/assets/js/35.131246cc.js"><link rel="prefetch" href="/assets/js/36.c62769a3.js"><link rel="prefetch" href="/assets/js/37.dbb122e4.js"><link rel="prefetch" href="/assets/js/38.2f4b3c78.js"><link rel="prefetch" href="/assets/js/39.25d82b38.js"><link rel="prefetch" href="/assets/js/40.f02cae42.js"><link rel="prefetch" href="/assets/js/41.85ab936e.js"><link rel="prefetch" href="/assets/js/42.1f378e94.js"><link rel="prefetch" href="/assets/js/43.d5c77d52.js"><link rel="prefetch" href="/assets/js/44.2f53e3cf.js"><link rel="prefetch" href="/assets/js/45.e8c2e103.js"><link rel="prefetch" href="/assets/js/46.42dd2bbd.js"><link rel="prefetch" href="/assets/js/48.78c3d5fd.js"><link rel="prefetch" href="/assets/js/49.9fba5340.js"><link rel="prefetch" href="/assets/js/50.e2483df2.js"><link rel="prefetch" href="/assets/js/51.1ce8a129.js"><link rel="prefetch" href="/assets/js/52.d711cd4e.js"><link rel="prefetch" href="/assets/js/53.c7803802.js"><link rel="prefetch" href="/assets/js/54.bae792ff.js"><link rel="prefetch" href="/assets/js/55.7feea50b.js"><link rel="prefetch" href="/assets/js/56.2f16289f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ea168385.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      一个平庸的码农
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">吹水</a></div><div class="nav-item"><a href="/books/" class="nav-link">图书</a></div><div class="nav-item"><a href="/projects/" class="nav-link">小玩意</a></div><div class="nav-item"><a href="/slides/" class="nav-link">投影片</a></div><div class="nav-item"><a href="/music/" class="nav-link">音乐</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">社区</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="https://github.com/myst729" target="_blank" rel="noopener noreferrer" class="nav-link">GitHub</a></li><li class="dropdown-item"><!----><a href="https://stackoverflow.com/users/1032492" target="_blank" rel="noopener noreferrer" class="nav-link">StackOverflow</a></li></ul></div></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">吹水</a></div><div class="nav-item"><a href="/books/" class="nav-link">图书</a></div><div class="nav-item"><a href="/projects/" class="nav-link">小玩意</a></div><div class="nav-item"><a href="/slides/" class="nav-link">投影片</a></div><div class="nav-item"><a href="/music/" class="nav-link">音乐</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">社区</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="https://github.com/myst729" target="_blank" rel="noopener noreferrer" class="nav-link">GitHub</a></li><li class="dropdown-item"><!----><a href="https://stackoverflow.com/users/1032492" target="_blank" rel="noopener noreferrer" class="nav-link">StackOverflow</a></li></ul></div></div><!----></nav><!----></div><div class="page"><div class="content"><h1 id="借助-wind-js-编写更流畅的异步代码"><a href="#借助-wind-js-编写更流畅的异步代码" aria-hidden="true" class="header-anchor">#</a> 借助 Wind.js 编写更流畅的异步代码</h1><p>两个月前我写过一篇<a href="/posts/2012/clockwise-points-sorting.html">时钟方向坐标系点排序算法及 JavaScript 实现</a>。最初的演示只能打印输入输出，实在太简陋，因此我后来加了一个用 canvas 实现的排序结果图。由于这个图是一次生成的，跟我为文章制作的动画 GIF 图（见下图）相比，演示效果显得很一般。考虑到 canvas 可编程的特性，我决定给 demo 中的排序图加上动画，让演示效果更直观有趣。然而跟大多数的 JavaScript 异步编程一样，这个过程让人十分抓狂：为了满足延时的需求，程序原有的结构完全被拆开，分散在各种回调函数中。有没有一种工具可以让我们用同步的方式编写异步代码呢？老赵开发的 <a href="http://windjs.org/" target="_blank" rel="noopener noreferrer">Wind.js</a> 就是这样一种工具。本文将尝试使用传统的 <code>setTimeout</code> 大法和 Wind.js 分别实现给演示加上动画的需求。</p><p><img src="https://myst729.github.io/blog/images/2012/07/clockwise-points-sorting.gif" alt="Clockwise Points Sorting"></p><p>先来看看最初没有动画效果的演示代码，其中部分用伪代码代替（如果您对隐去的代码感兴趣，可以在<a href="https://github.com/myst729/clockwise-points-sorting/blob/gh-pages/demo1.html" target="_blank" rel="noopener noreferrer">这里</a>查看完整代码）。</p><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">drawLine</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 绘制线条 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">drawPoints</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 绘制所有输入的点 */</span>
 
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> points<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">drawLine</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>在按下“排序”按钮时，下面这行代码将会被执行，从而开始图像的绘制。其中 <code>clockwiseSorting</code> 是一个点排序的算法，具体内容请阅读<a href="/posts/2012/clockwise-points-sorting.html">前文</a>。</p><pre class="language-js"><code><span class="token function">drawPoints</span><span class="token punctuation">(</span><span class="token function">clockwiseSorting</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> basic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>由于 JavaScript 代码运行非常快，整个绘制过程所耗费的时间短到我们无法感知。如果要实现动画效果，就必须在绘制过程中插入足够长的延时，让它慢下来。现在假设我们想让绘制线条的过程慢一点，比如说，每 400 毫秒画一条线，应该怎么做呢？可以肯定的是我们不能再使用 <code>for</code> 循环了，因为 <code>for</code> 循环的每次迭代并不会等待上一次迭代中调用函数的返回。即使我们像下面这样，在循环中加入延时，也无法控制两次迭代之间的时间间隔，所有的线条都会在 400 毫秒后绘制出来。</p><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">drawPoints</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 绘制所有输入的点 */</span>
 
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> points<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">drawLine</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>目前常见的一个解决方案，是在每次绘制结束时调用下一次绘制。</p><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">drawLine</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 绘制线条 */</span>
 
        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> points<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果还有未绘制的线条，则继续下一次绘制</span>
            <span class="token function">drawLine</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">var</span> <span class="token function-variable function">drawPoints</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 绘制所有输入的点 */</span>
 
    <span class="token function">drawLine</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>如果你有回调癖，一定这样也不是不可以啦……</p><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">drawLine</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> i<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 绘制线条 */</span>
 
        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> points<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果还有未绘制的线条，则继续下一次绘制</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">var</span> <span class="token function-variable function">drawPoints</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 绘制所有输入的点 */</span>
 
    <span class="token function">drawLine</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> drawLine<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>怎么样，难看吗？原有代码的逻辑结构整个被拆散了，这大大增加了维护异步编程代码的成本。对于复杂项目的编程，如果同步代码结构有变动，异步代码不可避免要作出调整，糟糕时甚至不得不完全重写。要是能在原有结构不变的基础上实现异步编程，那就太爽了。“接下来，就是见证奇迹的时刻。”我们要用 Wind.js 来爽一把！</p><p>首先我们要引入 Wind.js 类库。根据官方网站提供的文档，只需要添加一行代码就可以了。</p><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>wind-all-0.7.1.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>然后要做的事情，就是按照 Wind.js 的方式编译原先用同步方式编写的 <code>drawPoints</code> 函数（即需要在 <code>for</code> 循环中加入延时的函数）。在需要延时的地方（循环中）调用 <code>$await</code>，程序运行到此处时就会暂停，当我们预设的时间过去以后，程序会从暂停中恢复过来，继续执行。</p><pre class="language-js"><code><span class="token keyword">var</span> drawPointsAsync <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span>Wind<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">'async'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 绘制所有输入的点 */</span>
 
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> points<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 延时 400 毫秒</span>
        $<span class="token keyword">await</span><span class="token punctuation">(</span>Wind<span class="token punctuation">.</span>Async<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token function">drawLine</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>最后只要调用 <code>start</code> 方法（千万别忘了哟~），就可以执行编译后的 <code>drawPointsAsync</code> 函数了。</p><pre class="language-js"><code><span class="token function">drawPointsAsync</span><span class="token punctuation">(</span><span class="token function">clockwiseSorting</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> basic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>大功告成，动画已经做好了。那 <code>drawLine</code> 函数怎么办？什么怎么办？已经完事了，根本不需要改动 <code>drawLine</code> 函数，神奇吧！到底有多神奇，看看下面这张 git diff 的截图，相信你会更加震惊。</p><p><img src="https://myst729.github.io/blog/images/2012/09/windjs-git-diff.png" alt="git diff"></p><p>从图中可以看到，使用 Wind.js 前后，代码只有几处非常小的改动，完全没有影响原有逻辑结构。相比于代码逻辑被回调函数肢解的传统手法，使用 Wind.js 编写的代码更简洁，易于维护，极大改善了异步编程的体验，解放了深陷回调漩涡的 JavaScript 程序员。</p><p>好了，对 Wind.js 的简单介绍就到这里。更多资料请访问 Wind.js 官方网站 <a href="http://windjs.org/" target="_blank" rel="noopener noreferrer">http://windjs.org/</a> 及其 <a href="https://github.com/JeffreyZhao/wind" target="_blank" rel="noopener noreferrer">GitHub 项目页面</a>，你还可以在新浪微博上关注 Wind.js 的作者 <a href="http://weibo.com/jeffz" target="_blank" rel="noopener noreferrer">@老赵</a>。</p><p>附录：文中提到的几个演示</p><ol><li><a href="https://myst729.github.io/clockwise-points-sorting/demo1.html" target="_blank" rel="noopener noreferrer">没有动画的最初版本</a></li><li><a href="https://myst729.github.io/clockwise-points-sorting/demo2.html" target="_blank" rel="noopener noreferrer">setTimeout 版本</a></li><li><a href="https://myst729.github.io/clockwise-points-sorting/demo3.html" target="_blank" rel="noopener noreferrer">使用 Wind.js 的版本</a></li></ol><p>去 GitHub 查看<a href="https://github.com/myst729/clockwise-points-sorting" target="_blank" rel="noopener noreferrer">上面几个演示的代码</a></p></div><!----><!----></div></div></div>
    <script src="/assets/js/47.600ab990.js" defer></script><script src="/assets/js/app.d4ce6780.js" defer></script>
  </body>
</html>
